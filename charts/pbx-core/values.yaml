# =====================================================
# PBX CORE - Production Values File
# This file controls:
#  - PBX Core application
#  - MySQL subchart
#  - Redis subchart
#  - Kafka (KRaft) subchart
# =====================================================

global:
  security:
    allowInsecureImages: false


# -----------------------------------------------------
# PBX CORE DEPLOYMENT SETTINGS
# -----------------------------------------------------
replicaCount: 3

image:
  repository: akashtripathi/pbx-core
  tag: "latest"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 9080

# Enable/disable Istio Gateway + Host routing
istio:
  enabled: true
  gateway: "front-dev/platform-ui-gateway"
  host: "api.platform-dev.dalaillama.com"

# HPA configuration
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 8
  targetCPUUtilizationPercentage: 50


# -----------------------------------------------------
# PROBES
# -----------------------------------------------------
livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: 9080
  initialDelaySeconds: 30
  periodSeconds: 30
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: 9080
  initialDelaySeconds: 20
  periodSeconds: 15
  failureThreshold: 3

# -----------------------------------------------------
# RESOURCE LIMITS
# -----------------------------------------------------
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2
    memory: 4Gi

# -----------------------------------------------------
# PDB FOR PBX CORE
# -----------------------------------------------------
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Enable/disable dependent charts
subcharts:
  mysql:
    enabled: true
  redis:
    enabled: true
  kafka:
    enabled: true

# =====================================================
# MYSQL SUBCHART OVERRIDES
# =====================================================
mysql:
  enabled: true
  
  image:
    repository: mysql
    tag: "8.0"
    pullPolicy: IfNotPresent

  # Use external secret - create it manually first
  existingSecret: "mysql-auth"

  # Leave empty when using existingSecret
  auth:
    rootPassword: ""
    user: "pbx_user"
    password: ""
    database: "pbx_core_db"

  replication:
    enabled: true
    replicas: 2

  persistence:
    size: 5Gi
    storageClass: ""

  resources:
    primary:
      requests:
        cpu: "500m"
        memory: "2Gi"
      limits:
        cpu: "2"
        memory: "4Gi"
    replica:
      requests:
        cpu: "300m"
        memory: "1Gi"
      limits:
        cpu: "1"
        memory: "2Gi"

  podDisruptionBudget:
    enabled: true
    minAvailable: 1

# =====================================================
# REDIS SUBCHART OVERRIDES (MASTER + REPLICAS)
# =====================================================
redis:
  image:
    repository: redis
    tag: "7.2"
    pullPolicy: IfNotPresent

  replicaCount: 2

  persistence:
    size: 5Gi
    storageClass: ""

  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# =====================================================
# KAFKA SUBCHART (KRaft Mode)
# =====================================================
kafka:
  image:
    repository: apache/kafka
    tag: "3.7.0"
    pullPolicy: IfNotPresent

  replicaCount: 3

  persistence:
    size: 10Gi
    storageClass: ""

    requests:
      cpu: 500m      # Reduced from 2000m
      memory: 1Gi    # Reduced from 4Gi
    limits:
      cpu: 1000m     # Reduced from 4000m
      memory: 2Gi    # Reduced from 8Gi
  kraft:
    enabled: true
    clusterId: ""  # set during helm install

# -----------------------------------------------------
# MONITORING / BACKUP
# -----------------------------------------------------
prometheus:
  enabled: true

backup:
  mysql:
    enabled: false
  kafka:
    enabled: false

# -----------------------------------------------------
# MISC
# -----------------------------------------------------
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9080"

networkPolicy:
  enabled: false

serviceAccount:
  create: true
  name: ""
  annotations: {}

ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts: []
  tls: []
